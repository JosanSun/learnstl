<!doctype html>
<html lang="zh" class=""><head><meta charset="utf-8"/><title data-react-helmet="true">【游戏框架系列】简单的图形学（三）——光源</title><meta name="renderer" content="webkit"/><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/><meta name="force-rendering" content="webkit"/><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/><meta name="google-site-verification" content="FTeR0c8arOPKh8c5DYh_9uu98_zJbaWw53J-Sch9MTg"/><link rel="shortcut icon" href="https://static.zhihu.com/static/favicon.ico" type="image/x-icon"/><link href="//static.zhihu.com/hemingway/app.36335a6d5e421112e55e12ecfbff7ac5.css" rel="stylesheet"/><style></style></head><body><div id="react-root"><div><div class="Layout av-cardBackground" data-zop-userToken="{&quot;userToken&quot;:&quot;&quot;}"><div class="Layout-navbarHolder"><header class="Navbar"><div class="Navbar-logo-wrapper"><a class="Navbar-logo icon-ic_zhihu_logo" href="//www.zhihu.com" target="_blank" rel="noopener noreferrer" aria-label="知乎首页"></a></div><div class="Navbar-postTitle Navbar-title"><a href="https://zhuanlan.zhihu.com/learncpp"><img class="Navbar-columnIcon" alt="学习C++" src="https://pic2.zhimg.com/v2-bf63794c542fc73b11e17014b7e0d01d_m.jpg"/></a><div class="Navbar-postTitleName"><span class="Navbar-postTitleMeta">首发于</span><a class="Navbar-postTitleMain" href="https://zhuanlan.zhihu.com/learncpp">学习C++</a></div></div><div class="Navbar-functionality"><a class="Navbar-write"><i class="icon icon-ic_nav_new"></i>写文章</a><button class="Button Navbar-loginButon Button--blue" type="button">登录</button></div></header></div><div></div><div class="Layout-main av-card av-paddingBottom av-bodyFont Layout-titleImage--normal"><div class="PostIndex-header av-paddingTop av-card" data-zop="{&quot;authorName&quot;:&quot;陈安&quot;,&quot;itemId&quot;:&quot;31015884&quot;,&quot;title&quot;:&quot;【游戏框架系列】简单的图形学（三）——光源&quot;,&quot;type&quot;:&quot;article&quot;}"><div class="TitleImage"><img alt="【游戏框架系列】简单的图形学（三）——光源" src="https://pic4.zhimg.com/v2-96c3565e3ac1da63a35a4568df23530b_r.png" class="TitleImage-imagePure"/></div><h1 class="PostIndex-title av-paddingSide av-titleFont">【游戏框架系列】简单的图形学（三）——光源</h1><div class="PostIndex-author"><a href="https://www.zhihu.com/people/bajdcc" target="_blank" rel="noopener noreferrer"><img class="Avatar-hemingway PostIndex-authorAvatar Avatar--xs" alt="陈安" src="https://pic4.zhimg.com/50/v2-cd6d61ad9ef94c41b9e77f8e0f727893_xs.jpg" srcset="https://pic4.zhimg.com/50/v2-cd6d61ad9ef94c41b9e77f8e0f727893_l.jpg 2x"/></a><a href="https://www.zhihu.com/people/bajdcc" target="_blank" class="PostIndex-authorName">陈安</a><span class="Bull"></span><div class="HoverTitle" data-hover-title="Tue, Nov 14, 2017 10:34 AM"><time datetime="Tue Nov 14 2017 10:34:07 GMT+0800 (CST)">23 days ago</time></div></div></div><div class="RichText PostIndex-content av-paddingSide av-card"><p>参考自：<a href="http://link.zhihu.com/?target=http%3A//www.cnblogs.com/miloyip/archive/2010/04/02/1702768.html" class=" wrap external" target="_blank" rel="nofollow noreferrer">用JavaScript玩转计算机图形学(二)基本光源 - Milo Yip - 博客园<i class="icon-external"></i></a>，主要讲述三种最基本的光源——平行光、点光源、聚光灯，其实就是三种数学模型。</p><p><br></p><h2>代码的调整</h2><p>先前的代码中，颜色是由几何物体自身计算得出，因此使用很有限。在Phong材质中，显示的效果已经很不错了，然而Phong材质是要假定有一个光源的。我们的代码需要从以面向物体渲染为面向光源渲染。</p><p>新的逻辑：<a href="http://link.zhihu.com/?target=https%3A//github.com/bajdcc/GameFramework/blob/master/CCGameFramework/base/pe2d/Render2DLight.cpp" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">github.com/bajdcc/GameF</span><span class="invisible">ramework/blob/master/CCGameFramework/base/pe2d/Render2DLight.cpp</span><span class="ellipsis"></span><i class="icon-external"></i></a></p><p>主逻辑 代码：</p><div class="highlight"><pre><code class="language-cpp"><span></span><span class="kt">void</span> <span class="n">PhysicsEngine</span><span class="o">::</span><span class="n">RenderLightIntern</span><span class="p">(</span><span class="n">World</span><span class="o">&amp;</span> <span class="n">world</span><span class="p">,</span> <span class="k">const</span> <span class="n">PerspectiveCamera</span><span class="o">&amp;</span> <span class="n">camera</span><span class="p">,</span> <span class="n">BYTE</span><span class="o">*</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">cint</span> <span class="n">width</span><span class="p">,</span> <span class="n">cint</span> <span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="k">auto</span> <span class="n">sy</span> <span class="o">=</span> <span class="mf">1.0f</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.0f</span> <span class="o">*</span> <span class="n">y</span> <span class="o">/</span> <span class="n">height</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">const</span> <span class="k">auto</span> <span class="n">sx</span> <span class="o">=</span> <span class="mf">1.0f</span> <span class="o">*</span> <span class="n">x</span> <span class="o">/</span> <span class="n">width</span><span class="p">;</span>

            <span class="c1">// sx和sy将屏幕投影到[0,1]区间</span>

            <span class="c1">// 产生光线</span>
            <span class="k">const</span> <span class="k">auto</span> <span class="n">ray</span> <span class="o">=</span> <span class="n">camera</span><span class="p">.</span><span class="n">GenerateRay</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">);</span>

            <span class="c1">// 测试光线与球是否相交</span>
            <span class="k">auto</span> <span class="n">result</span> <span class="o">=</span> <span class="n">world</span><span class="p">.</span><span class="n">Intersect</span><span class="p">(</span><span class="n">ray</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">body</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">color</span> <span class="n">color</span><span class="p">;</span>
                <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span> <span class="nl">k</span> <span class="p">:</span> <span class="n">world</span><span class="p">.</span><span class="n">lights</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 这里不一样了</span>
                    <span class="k">auto</span> <span class="n">lightSample</span> <span class="o">=</span> <span class="n">k</span><span class="o">-&gt;</span><span class="n">Sample</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="n">result</span><span class="p">.</span><span class="n">position</span><span class="p">);</span>

                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lightSample</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
                        <span class="k">auto</span> <span class="n">NdotL</span> <span class="o">=</span> <span class="n">DotProduct</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">normal</span><span class="p">,</span> <span class="n">lightSample</span><span class="p">.</span><span class="n">L</span><span class="p">);</span> <span class="c1">// 计算角度</span>

                        <span class="c1">// 夹角为锐角，光源在平面前面</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">NdotL</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="c1">// 累计所有光线</span>
                            <span class="c1">// NdotL 就是光源方向在法向量上的投影</span>
                            <span class="n">color</span> <span class="o">=</span> <span class="n">color</span> <span class="o">+</span> <span class="p">(</span><span class="n">lightSample</span><span class="p">.</span><span class="n">EL</span> <span class="o">*</span> <span class="n">NdotL</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">BYTE</span><span class="p">(</span><span class="n">color</span><span class="p">.</span><span class="n">b</span> <span class="o">*</span> <span class="mi">255</span><span class="p">);</span>
                <span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">BYTE</span><span class="p">(</span><span class="n">color</span><span class="p">.</span><span class="n">g</span> <span class="o">*</span> <span class="mi">255</span><span class="p">);</span>
                <span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">BYTE</span><span class="p">(</span><span class="n">color</span><span class="p">.</span><span class="n">r</span> <span class="o">*</span> <span class="mi">255</span><span class="p">);</span>
                <span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="c1">// 没有接触，就是背景色</span>
                <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">buffer</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p><br></p><p>简单来说，就是求出交点时，做：</p><ol><li>计算各大光源基于该点的光线颜色和光线方向</li><li>计算光线在交点法向量上的投影，作为颜色混合比的依据</li><li>将所有颜色累计起来</li></ol><p><br></p><p>下面介绍三种光源</p><h2>平行光</h2><figure><noscript><img src="https://pic2.zhimg.com/v2-eebcbf64e85256332bb0c0f94d8cbf4d_b.jpg" data-rawwidth="1031" data-rawheight="628" class="origin_image zh-lightbox-thumb" width="1031" data-original="https://pic2.zhimg.com/v2-eebcbf64e85256332bb0c0f94d8cbf4d_r.jpg"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='1031'%20height='628'&gt;&lt;/svg&gt;" data-rawwidth="1031" data-rawheight="628" class="origin_image zh-lightbox-thumb lazy" width="1031" data-original="https://pic2.zhimg.com/v2-eebcbf64e85256332bb0c0f94d8cbf4d_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-eebcbf64e85256332bb0c0f94d8cbf4d_b.jpg"><figcaption>平行光</figcaption></figure><p>平行光的属性：</p><div class="highlight"><pre><code class="language-cpp"><span></span><span class="c1">// 平行光</span>
<span class="k">class</span> <span class="nc">DirectionalLight</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Light</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="n">DirectionalLight</span><span class="p">(</span><span class="n">color</span> <span class="n">irradiance</span><span class="p">,</span> <span class="n">vector3</span> <span class="n">direction</span><span class="p">);</span>

    <span class="n">LightSample</span> <span class="nf">Sample</span><span class="p">(</span><span class="n">World</span><span class="o">&amp;</span> <span class="n">world</span><span class="p">,</span> <span class="n">vector3</span> <span class="n">position</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>

    <span class="n">color</span> <span class="n">irradiance</span><span class="p">;</span>    <span class="c1">// 幅照度</span>
    <span class="n">vector3</span> <span class="n">direction</span><span class="p">;</span>   <span class="c1">// 光照方向</span>
    <span class="n">vector3</span> <span class="n">L</span><span class="p">;</span>           <span class="c1">// 光源方向</span>
<span class="p">};</span>

<span class="n">DirectionalLight</span><span class="o">::</span><span class="n">DirectionalLight</span><span class="p">(</span><span class="n">color</span> <span class="n">irradiance</span><span class="p">,</span> <span class="n">vector3</span> <span class="n">direction</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">irradiance</span><span class="p">(</span><span class="n">irradiance</span><span class="p">),</span> <span class="n">direction</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">L</span> <span class="o">=</span> <span class="o">-</span><span class="n">Normalize</span><span class="p">(</span><span class="n">direction</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">LightSample</span> <span class="n">DirectionalLight</span><span class="o">::</span><span class="n">Sample</span><span class="p">(</span><span class="n">World</span><span class="o">&amp;</span> <span class="n">world</span><span class="p">,</span> <span class="n">vector3</span> <span class="n">position</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="n">LightSample</span> <span class="n">zero</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">shadow</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">const</span> <span class="n">Ray</span> <span class="n">shadowRay</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">L</span><span class="p">);</span>
        <span class="k">const</span> <span class="k">auto</span> <span class="n">shadowResult</span> <span class="o">=</span> <span class="n">world</span><span class="p">.</span><span class="n">Intersect</span><span class="p">(</span><span class="n">shadowRay</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">shadowResult</span><span class="p">.</span><span class="n">body</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">zero</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">LightSample</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">irradiance</span><span class="p">);</span> <span class="c1">// 就返回光源颜色</span>
<span class="p">}</span>
</code></pre></div><p>这里注意L是光源方向单位向量。</p><p>平行光我们只需要知道光源方向和光源颜色就可以了。非常简单，不用算投影，这是主逻辑的工作。</p><p>这里说一下阴影，平行光有阴影，当从交点向光源方向看时，如果中间有障碍物，就返回黑色。</p><p><br></p><h2>点光源</h2><figure><noscript><img src="https://pic1.zhimg.com/v2-359fc82a77ddc70179ca78a0ea62b2e8_b.jpg" data-rawwidth="1031" data-rawheight="628" class="origin_image zh-lightbox-thumb" width="1031" data-original="https://pic1.zhimg.com/v2-359fc82a77ddc70179ca78a0ea62b2e8_r.jpg"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='1031'%20height='628'&gt;&lt;/svg&gt;" data-rawwidth="1031" data-rawheight="628" class="origin_image zh-lightbox-thumb lazy" width="1031" data-original="https://pic1.zhimg.com/v2-359fc82a77ddc70179ca78a0ea62b2e8_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-359fc82a77ddc70179ca78a0ea62b2e8_b.jpg"><figcaption>点光源</figcaption></figure><div class="highlight"><pre><code class="language-cpp"><span></span><span class="c1">// 点光源</span>
<span class="k">class</span> <span class="nc">PointLight</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Light</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="n">PointLight</span><span class="p">(</span><span class="n">color</span> <span class="n">intensity</span><span class="p">,</span> <span class="n">vector3</span> <span class="n">position</span><span class="p">);</span>

    <span class="n">LightSample</span> <span class="nf">Sample</span><span class="p">(</span><span class="n">World</span><span class="o">&amp;</span> <span class="n">world</span><span class="p">,</span> <span class="n">vector3</span> <span class="n">position</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>

    <span class="n">color</span> <span class="n">intensity</span><span class="p">;</span>     <span class="c1">// 幅射强度</span>
    <span class="n">vector3</span> <span class="n">position</span><span class="p">;</span>    <span class="c1">// 光源位置</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">LightSample</span> <span class="n">zero</span><span class="p">;</span>

<span class="n">LightSample</span> <span class="n">PointLight</span><span class="o">::</span><span class="n">Sample</span><span class="p">(</span><span class="n">World</span><span class="o">&amp;</span> <span class="n">world</span><span class="p">,</span> <span class="n">vector3</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// 计算L，但保留r和r^2，供之后使用</span>
    <span class="k">const</span> <span class="k">auto</span> <span class="n">delta</span> <span class="o">=</span> <span class="n">position</span> <span class="o">-</span> <span class="n">pos</span><span class="p">;</span> <span class="c1">// 距离向量</span>
    <span class="k">const</span> <span class="k">auto</span> <span class="n">rr</span> <span class="o">=</span> <span class="n">SquareMagnitude</span><span class="p">(</span><span class="n">delta</span><span class="p">);</span>
    <span class="k">const</span> <span class="k">auto</span> <span class="n">r</span> <span class="o">=</span> <span class="n">sqrtf</span><span class="p">(</span><span class="n">rr</span><span class="p">);</span> <span class="c1">// 算出光源到pos的距离</span>
    <span class="k">const</span> <span class="k">auto</span> <span class="n">L</span> <span class="o">=</span> <span class="n">delta</span> <span class="o">/</span> <span class="n">r</span><span class="p">;</span> <span class="c1">// 距离单位向量</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">shadow</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">const</span> <span class="n">Ray</span> <span class="n">shadowRay</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">L</span><span class="p">);</span>
        <span class="k">const</span> <span class="k">auto</span> <span class="n">shadowResult</span> <span class="o">=</span> <span class="n">world</span><span class="p">.</span><span class="n">Intersect</span><span class="p">(</span><span class="n">shadowRay</span><span class="p">);</span>
        <span class="c1">// 在r以内的相交点才会遮蔽光源</span>
        <span class="c1">// shadowResult.distance &lt;= r 表示：</span>
        <span class="c1">//   以pos交点 -&gt; 光源位置 发出一条阴影测试光线</span>
        <span class="c1">//   如果阴影测试光线与其他物体有交点，那么相交距离 &lt;= r</span>
        <span class="c1">//   说明pos位置无法直接看到光源</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">shadowResult</span><span class="p">.</span><span class="n">body</span> <span class="o">&amp;&amp;</span> <span class="n">shadowResult</span><span class="p">.</span><span class="n">distance</span> <span class="o">&lt;=</span> <span class="n">r</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">zero</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 平方反比衰减</span>
    <span class="k">const</span> <span class="k">auto</span> <span class="n">attenuation</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">rr</span><span class="p">;</span>

    <span class="c1">// 返回衰减后的光源颜色</span>
    <span class="k">return</span> <span class="nf">LightSample</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">intensity</span> <span class="o">*</span> <span class="n">attenuation</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p>点光源有一个平方反比衰减规律，故而要先算光源到交点pos的距离r，然后求出L，实际上L就是光源位置到交点的方向单位向量。接着要计算颜色，点光源本身颜色intensity，由于有衰减，因此变成了intensity * attenuation。</p><p>再说下阴影，如何计算点光源的阴影？这比平行光复杂些。从交点处向光源位置发出一条光线，如果当中有障碍物，那么被遮挡，返回黑色（就是遮挡测试）。</p><p><br></p><h2>聚光灯</h2><figure><noscript><img src="https://pic4.zhimg.com/v2-96c3565e3ac1da63a35a4568df23530b_b.jpg" data-rawwidth="1031" data-rawheight="628" class="origin_image zh-lightbox-thumb" width="1031" data-original="https://pic4.zhimg.com/v2-96c3565e3ac1da63a35a4568df23530b_r.jpg"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='1031'%20height='628'&gt;&lt;/svg&gt;" data-rawwidth="1031" data-rawheight="628" class="origin_image zh-lightbox-thumb lazy" width="1031" data-original="https://pic4.zhimg.com/v2-96c3565e3ac1da63a35a4568df23530b_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-96c3565e3ac1da63a35a4568df23530b_b.jpg"><figcaption>聚光灯</figcaption></figure><div class="highlight"><pre><code class="language-cpp"><span></span><span class="c1">// 聚光灯</span>
<span class="k">class</span> <span class="nc">SpotLight</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Light</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="n">SpotLight</span><span class="p">(</span><span class="n">color</span> <span class="n">intensity</span><span class="p">,</span> <span class="n">vector3</span> <span class="n">position</span><span class="p">,</span> <span class="n">vector3</span> <span class="n">direction</span><span class="p">,</span> <span class="kt">float</span> <span class="n">theta</span><span class="p">,</span> <span class="kt">float</span> <span class="n">phi</span><span class="p">,</span> <span class="kt">float</span> <span class="n">falloff</span><span class="p">);</span>

    <span class="n">LightSample</span> <span class="nf">Sample</span><span class="p">(</span><span class="n">World</span><span class="o">&amp;</span> <span class="n">world</span><span class="p">,</span> <span class="n">vector3</span> <span class="n">position</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>

    <span class="n">color</span> <span class="n">intensity</span><span class="p">;</span>     <span class="c1">// 幅射强度</span>
    <span class="n">vector3</span> <span class="n">position</span><span class="p">;</span>    <span class="c1">// 光源位置</span>
    <span class="n">vector3</span> <span class="n">direction</span><span class="p">;</span>   <span class="c1">// 光照方向</span>
    <span class="kt">float</span> <span class="n">theta</span><span class="p">;</span>         <span class="c1">// 内圆锥的内角</span>
    <span class="kt">float</span> <span class="n">phi</span><span class="p">;</span>           <span class="c1">// 外圆锥的内角</span>
    <span class="kt">float</span> <span class="n">falloff</span><span class="p">;</span>       <span class="c1">// 衰减</span>

    <span class="cm">/* 以下为预计算常量 */</span>
    <span class="n">vector3</span> <span class="n">S</span><span class="p">;</span>           <span class="c1">// 光源方向</span>
    <span class="kt">float</span> <span class="n">cosTheta</span><span class="p">;</span>      <span class="c1">// cos(内圆锥角)</span>
    <span class="kt">float</span> <span class="n">cosPhi</span><span class="p">;</span>        <span class="c1">// cos(外圆锥角)</span>
    <span class="kt">float</span> <span class="n">baseMultiplier</span><span class="p">;</span><span class="c1">// 1/(cosTheta-cosPhi)</span>
<span class="p">};</span>

<span class="n">SpotLight</span><span class="o">::</span><span class="n">SpotLight</span><span class="p">(</span><span class="n">color</span> <span class="n">intensity</span><span class="p">,</span> <span class="n">vector3</span> <span class="n">position</span><span class="p">,</span> <span class="n">vector3</span> <span class="n">direction</span><span class="p">,</span> <span class="kt">float</span> <span class="n">theta</span><span class="p">,</span> <span class="kt">float</span> <span class="n">phi</span><span class="p">,</span> <span class="kt">float</span> <span class="n">falloff</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">intensity</span><span class="p">(</span><span class="n">intensity</span><span class="p">),</span> <span class="n">position</span><span class="p">(</span><span class="n">position</span><span class="p">),</span> <span class="n">direction</span><span class="p">(</span><span class="n">direction</span><span class="p">),</span> <span class="n">theta</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="n">phi</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">falloff</span><span class="p">(</span><span class="n">falloff</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">S</span> <span class="o">=</span> <span class="o">-</span><span class="n">Normalize</span><span class="p">(</span><span class="n">direction</span><span class="p">);</span>
    <span class="n">cosTheta</span> <span class="o">=</span> <span class="n">cosf</span><span class="p">(</span><span class="n">theta</span> <span class="o">*</span> <span class="kt">float</span><span class="p">(</span><span class="n">M_PI</span><span class="p">)</span> <span class="o">/</span> <span class="mf">360.0f</span><span class="p">);</span>
    <span class="n">cosPhi</span> <span class="o">=</span> <span class="n">cosf</span><span class="p">(</span><span class="n">phi</span> <span class="o">*</span> <span class="kt">float</span><span class="p">(</span><span class="n">M_PI</span><span class="p">)</span> <span class="o">/</span> <span class="mf">360.0f</span><span class="p">);</span>
    <span class="n">baseMultiplier</span> <span class="o">=</span> <span class="mf">1.0f</span> <span class="o">/</span> <span class="p">(</span><span class="n">cosTheta</span> <span class="o">-</span> <span class="n">cosPhi</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">LightSample</span> <span class="n">SpotLight</span><span class="o">::</span><span class="n">Sample</span><span class="p">(</span><span class="n">World</span><span class="o">&amp;</span> <span class="n">world</span><span class="p">,</span> <span class="n">vector3</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// 计算L，但保留r和r^2，供之后使用</span>
    <span class="k">const</span> <span class="k">auto</span> <span class="n">delta</span> <span class="o">=</span> <span class="n">position</span> <span class="o">-</span> <span class="n">pos</span><span class="p">;</span> <span class="c1">// 距离向量</span>
    <span class="k">const</span> <span class="k">auto</span> <span class="n">rr</span> <span class="o">=</span> <span class="n">SquareMagnitude</span><span class="p">(</span><span class="n">delta</span><span class="p">);</span>
    <span class="k">const</span> <span class="k">auto</span> <span class="n">r</span> <span class="o">=</span> <span class="n">sqrtf</span><span class="p">(</span><span class="n">rr</span><span class="p">);</span> <span class="c1">// 算出光源到pos的距离</span>
    <span class="k">const</span> <span class="k">auto</span> <span class="n">L</span> <span class="o">=</span> <span class="n">delta</span> <span class="o">/</span> <span class="n">r</span><span class="p">;</span> <span class="c1">// 距离单位向量</span>

    <span class="cm">/*</span>
<span class="cm">     * spot(alpha) =</span>
<span class="cm">     *</span>
<span class="cm">     *     1</span>
<span class="cm">     *         where cos(alpha) &gt;= cos(theta/2)</span>
<span class="cm">     *</span>
<span class="cm">     *     pow( (cos(alpha) - cos(phi/2)) / (cos(theta/2) - cos(phi/2)) , p)</span>
<span class="cm">     *         where cos(phi/2) &lt; cos(alpha) &lt; cos(theta/2)</span>
<span class="cm">     *</span>
<span class="cm">     *     0</span>
<span class="cm">     *         where cos(alpha) &lt;= cos(phi/2)</span>
<span class="cm">     */</span>

    <span class="c1">// 计算spot</span>
    <span class="k">auto</span> <span class="n">spot</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
    <span class="k">const</span> <span class="k">auto</span> <span class="n">SdotL</span> <span class="o">=</span> <span class="n">DotProduct</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">L</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">SdotL</span> <span class="o">&gt;=</span> <span class="n">cosTheta</span><span class="p">)</span>
        <span class="n">spot</span> <span class="o">=</span> <span class="mf">1.0f</span><span class="p">;</span>
    <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">SdotL</span> <span class="o">&lt;=</span> <span class="n">cosPhi</span><span class="p">)</span>
        <span class="n">spot</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
    <span class="k">else</span>
        <span class="n">spot</span> <span class="o">=</span> <span class="n">powf</span><span class="p">((</span><span class="n">SdotL</span> <span class="o">-</span> <span class="n">cosPhi</span><span class="p">)</span> <span class="o">*</span> <span class="n">baseMultiplier</span><span class="p">,</span> <span class="n">falloff</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">shadow</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">const</span> <span class="n">Ray</span> <span class="n">shadowRay</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">L</span><span class="p">);</span>
        <span class="k">const</span> <span class="k">auto</span> <span class="n">shadowResult</span> <span class="o">=</span> <span class="n">world</span><span class="p">.</span><span class="n">Intersect</span><span class="p">(</span><span class="n">shadowRay</span><span class="p">);</span>
        <span class="c1">// 在r以内的相交点才会遮蔽光源</span>
        <span class="c1">// shadowResult.distance &lt;= r 表示：</span>
        <span class="c1">//   以pos交点 -&gt; 光源位置 发出一条阴影测试光线</span>
        <span class="c1">//   如果阴影测试光线与其他物体有交点，那么相交距离 &lt;= r</span>
        <span class="c1">//   说明pos位置无法直接看到光源</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">shadowResult</span><span class="p">.</span><span class="n">body</span> <span class="o">&amp;&amp;</span> <span class="n">shadowResult</span><span class="p">.</span><span class="n">distance</span> <span class="o">&lt;=</span> <span class="n">r</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">zero</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 平方反比衰减</span>
    <span class="k">const</span> <span class="k">auto</span> <span class="n">attenuation</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">rr</span><span class="p">;</span>

    <span class="c1">// 返回衰减后的光源颜色</span>
    <span class="k">return</span> <span class="nf">LightSample</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">intensity</span> <span class="o">*</span> <span class="p">(</span><span class="n">attenuation</span> <span class="o">*</span> <span class="n">spot</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div><p>聚光灯是非常复杂的数学模型，我们不去探究为什么公式这样的，只要实现就行。</p><p>纯数学计算不多讲，这里主要有一个spot（聚光灯系数），所以最后的颜色是intensity * (attenuation * spot)。其它跟点光源的实现也差不多。</p><p><br></p><h2>三原色混合</h2><figure><noscript><img src="https://pic2.zhimg.com/v2-41d32560b89247764d277c3eb5e4924d_b.jpg" data-rawwidth="1031" data-rawheight="628" class="origin_image zh-lightbox-thumb" width="1031" data-original="https://pic2.zhimg.com/v2-41d32560b89247764d277c3eb5e4924d_r.jpg"></noscript><img src="data:image/svg+xml;utf8,&lt;svg%20xmlns='http://www.w3.org/2000/svg'%20width='1031'%20height='628'&gt;&lt;/svg&gt;" data-rawwidth="1031" data-rawheight="628" class="origin_image zh-lightbox-thumb lazy" width="1031" data-original="https://pic2.zhimg.com/v2-41d32560b89247764d277c3eb5e4924d_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-41d32560b89247764d277c3eb5e4924d_b.jpg"><figcaption>光的三原色</figcaption></figure><p>原想这东西怎么实现啊，现在想通了，就是在某点处(plane上一点)三个聚光灯打上去，将最终的颜色混合起来(加起来)。</p><p>简单表述：三个光源的光分别为RGB(255,0,0)、RGB(0,255,0)、RGB(0,0,255)，混合起来，加一下就是RGB(255,255,255)，白色。</p><p>看到<a href="http://link.zhihu.com/?target=http%3A//www.cnblogs.com/miloyip/archive/2010/04/02/1702768.html" class=" wrap external" target="_blank" rel="nofollow noreferrer">用JavaScript玩转计算机图形学(二)基本光源 - Milo Yip - 博客园<i class="icon-external"></i></a> 中的一个问题：</p><blockquote>如果，幅射强度是负值的话，会怎么样？(虽然未证实反光子(antiphoton)的存在，但读者能想到图形学上的功能么？)</blockquote><p>感觉就是PS中的正片叠底啊，见<a href="https://www.zhihu.com/question/20354981" class="internal">如何简单的理解正片叠底和滤色？</a>。</p><p><br></p><p>接下来会探讨画光的实现。</p></div><div class="PostIndex-footer"><div class="PostIndex-topics TopicItem-wrapper"><a class="TopicItem u-ellipsis PostIndex-topicItem" href="https://www.zhihu.com/topic/19613730">计算机图形学</a><a class="TopicItem u-ellipsis PostIndex-topicItem" href="https://www.zhihu.com/topic/19601705">C / C++</a><a class="TopicItem u-ellipsis PostIndex-topicItem" href="https://www.zhihu.com/topic/20065767">光线跟踪</a></div><div class="PostIndex-reviewers"></div><div class="PostIndex-vote"><button class="Button PostIndex-voteButton Button--green" aria-label="赞" type="button"><i class="icon icon-ic_column_like"></i>2</button><div class="PostIndex-voters"><div class="HoverTitle HoverTitle--slim" data-hover-title="赵小果"><a href="https://www.zhihu.com/people/zhao-xiao-guo-35-7" class="PostIndex-voter" target="_blank"><img class="Avatar-hemingway Avatar--is" alt="赵小果" src="https://pic1.zhimg.com/50/v2-1360d9202a72976effe3615921f95c54_is.jpg" srcset="https://pic1.zhimg.com/50/v2-1360d9202a72976effe3615921f95c54_im.jpg 2x"/></a></div><div class="HoverTitle HoverTitle--slim" data-hover-title="小菜鸟"><a href="https://www.zhihu.com/people/feng-yu-sheng-1" class="PostIndex-voter" target="_blank"><img class="Avatar-hemingway Avatar--is" alt="小菜鸟" src="https://pic1.zhimg.com/da8e974dc_is.jpg" srcset="https://pic1.zhimg.com/da8e974dc_im.jpg 2x"/></a></div><a href="/p/31015884/voters" target="_blank" rel="noopener noreferrer" title="查看全部" class="PostIndex-allVoters"><i class="icon-ic_like_more"></i></a></div></div><div class="PostIndex-control"><div class="Fav"><button class="Button Button Button--plain FavButton" type="button"><i class="icon icon-ic_collect"></i>收藏</button></div><div class="PostShare"><div class="Menu"><button class="Button Button Button--plain MenuButton MenuButton-listen-hover Button Button--plain" type="button"><i class="icon icon-ic_column_share"></i>分享</button><div class="Menu-dropdown" style="visibility:hidden;"></div></div></div><div class="Report"><button class="Button Button Button--plain ReportButton" type="button"><i class="icon icon-ic_column_report"></i>举报</button></div></div></div><div class="Contributes PostIndex-contributes av-card"><div class="BlockTitle av-marginLeft av-borderColor"><span class="BlockTitle-title">文章被以下专栏收录</span><span class="BlockTitle-line"></span></div><ul class="Contributes-list"><li style="opacity:1;max-height:300px;" class="Contributes-listItem av-borderColor av-marginLeft"><div class="ContributesItem av-paddingRight" role="link"><a class="ContributesItem-avatar" href="/learncpp"><img class="Avatar-hemingway" src="https://pic2.zhimg.com/v2-bf63794c542fc73b11e17014b7e0d01d_m.jpg" srcset="https://pic2.zhimg.com/v2-bf63794c542fc73b11e17014b7e0d01d_xl.jpg 2x"/></a><div class="ContributesItem-info"><div class="ContributesItem-nameLine"><a class="ContributesItem-name" href="https://zhuanlan.zhihu.com/learncpp">学习C++</a></div><p class="ContributesItem-intro u-ellipsis">写写C++</p></div><a class="ContributesItem-entrance" href="https://zhuanlan.zhihu.com/learncpp">进入专栏</a></div></li></ul></div><div class="PostComment"><div class="BlockTitle av-marginLeft av-borderColor PostComment-blockTitle"><span class="BlockTitle-title">还没有评论</span><span class="BlockTitle-line"></span></div><div class="CommentEditor PostComment-mainEditor"><div class="CommentEditor-input"><div class="CommentEditor-actions"><button class="Button Button--plain" type="button">取消</button><button class="Button Button--blue" disabled="" type="button">评论</button></div></div></div><div class="PostCommentList"></div></div><div class="PostIndex-recommendZone av-card"><div class="BlockTitle av-marginLeft av-borderColor"><span class="BlockTitle-title">推荐阅读</span><span class="BlockTitle-line"></span></div><div class="Spinner"></div></div></div></div></div></div><textarea id="clientConfig" hidden="">{&quot;debug&quot;:false,&quot;apiRoot&quot;:&quot;&quot;,&quot;paySDK&quot;:&quot;https:\u002F\u002Fpay.zhihu.com\u002Fapi\u002Fjs&quot;,&quot;wechatConfigAPI&quot;:&quot;\u002Fapi\u002Fwechat\u002Fjssdkconfig&quot;,&quot;name&quot;:&quot;production&quot;,&quot;instance&quot;:&quot;column&quot;,&quot;tokens&quot;:{&quot;X-XSRF-TOKEN&quot;:null,&quot;X-UDID&quot;:null,&quot;Authorization&quot;:&quot;oauth c3cef7c66a1843f8b3a9e6a1e3160e20&quot;}}</textarea><textarea id="preloadedState" hidden="">{&quot;database&quot;:{&quot;Post&quot;:{&quot;31015884&quot;:{&quot;isPending&quot;:false,&quot;contributes&quot;:[{&quot;sourceColumn&quot;:{&quot;lastUpdated&quot;:1497249764,&quot;description&quot;:&quot;玩玩有趣的东西&quot;,&quot;permission&quot;:&quot;COLUMN_PUBLIC&quot;,&quot;memberId&quot;:10760740,&quot;contributePermission&quot;:&quot;COLUMN_PUBLIC&quot;,&quot;translatedCommentPermission&quot;:&quot;all&quot;,&quot;canManage&quot;:true,&quot;intro&quot;:&quot;写写C++&quot;,&quot;urlToken&quot;:&quot;learncpp&quot;,&quot;id&quot;:25963,&quot;imagePath&quot;:&quot;v2-bf63794c542fc73b11e17014b7e0d01d.jpg&quot;,&quot;slug&quot;:&quot;learncpp&quot;,&quot;applyReason&quot;:&quot;0&quot;,&quot;name&quot;:&quot;学习C++&quot;,&quot;title&quot;:&quot;学习C++&quot;,&quot;url&quot;:&quot;https:\u002F\u002Fzhuanlan.zhihu.com\u002Flearncpp&quot;,&quot;commentPermission&quot;:&quot;COLUMN_ALL_CAN_COMMENT&quot;,&quot;canPost&quot;:true,&quot;created&quot;:1483611626,&quot;state&quot;:&quot;COLUMN_NORMAL&quot;,&quot;followers&quot;:2913,&quot;avatar&quot;:{&quot;id&quot;:&quot;v2-bf63794c542fc73b11e17014b7e0d01d&quot;,&quot;template&quot;:&quot;https:\u002F\u002Fpic2.zhimg.com\u002F{id}_{size}.jpg&quot;},&quot;activateAuthorRequested&quot;:false,&quot;following&quot;:false,&quot;imageUrl&quot;:&quot;https:\u002F\u002Fpic2.zhimg.com\u002Fv2-bf63794c542fc73b11e17014b7e0d01d_l.jpg&quot;,&quot;articlesCount&quot;:53},&quot;state&quot;:&quot;accepted&quot;,&quot;targetPost&quot;:{&quot;titleImage&quot;:&quot;https:\u002F\u002Fpic4.zhimg.com\u002Fv2-96c3565e3ac1da63a35a4568df23530b_r.png&quot;,&quot;lastUpdated&quot;:1510626952,&quot;imagePath&quot;:&quot;v2-96c3565e3ac1da63a35a4568df23530b.png&quot;,&quot;permission&quot;:&quot;ARTICLE_PUBLIC&quot;,&quot;topics&quot;:[21222,17215,174374],&quot;summary&quot;:&quot;参考自：\u003Ca href=\&quot;http:\u002F\u002Fwww.cnblogs.com\u002Fmiloyip\u002Farchive\u002F2010\u002F04\u002F02\u002F1702768.html\&quot;\u003E用JavaScript玩转计算机图形学(二)基本光源 - Milo Yip - 博客园\u003C\u002Fa\u003E，主要讲述三种最基本的光源——平行光、点光源、聚光灯，其实就是三种数学模型。 代码的调整先前的代码中，颜色是由几何物体自身计算得出，因此使用很有限。在Phong材质中，显示的效…&quot;,&quot;copyPermission&quot;:&quot;ARTICLE_COPYABLE&quot;,&quot;translatedCommentPermission&quot;:&quot;all&quot;,&quot;likes&quot;:0,&quot;origAuthorId&quot;:0,&quot;publishedTime&quot;:&quot;2017-11-14T10:34:07+08:00&quot;,&quot;sourceUrl&quot;:&quot;&quot;,&quot;urlToken&quot;:31015884,&quot;id&quot;:4595020,&quot;withContent&quot;:false,&quot;slug&quot;:31015884,&quot;bigTitleImage&quot;:false,&quot;title&quot;:&quot;【游戏框架系列】简单的图形学（三）——光源&quot;,&quot;url&quot;:&quot;\u002Fp\u002F31015884&quot;,&quot;commentPermission&quot;:&quot;ARTICLE_ALL_CAN_COMMENT&quot;,&quot;snapshotUrl&quot;:&quot;&quot;,&quot;created&quot;:1510626847,&quot;comments&quot;:0,&quot;columnId&quot;:0,&quot;content&quot;:&quot;&quot;,&quot;parentId&quot;:0,&quot;state&quot;:&quot;ARTICLE_PUBLISHED&quot;,&quot;imageUrl&quot;:&quot;https:\u002F\u002Fpic4.zhimg.com\u002Fv2-96c3565e3ac1da63a35a4568df23530b_r.png&quot;,&quot;author&quot;:{&quot;bio&quot;:&quot;专业研究野生技术&quot;,&quot;isFollowing&quot;:false,&quot;hash&quot;:&quot;7a228f3d98a5d011f952110c10dc4976&quot;,&quot;uid&quot;:71809588264960,&quot;isOrg&quot;:false,&quot;slug&quot;:&quot;bajdcc&quot;,&quot;isFollowed&quot;:false,&quot;description&quot;:&quot;专业研究野生技术 https:\u002F\u002Fgithub.com\u002Fbajdcc&quot;,&quot;name&quot;:&quot;陈安&quot;,&quot;profileUrl&quot;:&quot;https:\u002F\u002Fwww.zhihu.com\u002Fpeople\u002Fbajdcc&quot;,&quot;avatar&quot;:{&quot;id&quot;:&quot;v2-cd6d61ad9ef94c41b9e77f8e0f727893&quot;,&quot;template&quot;:&quot;https:\u002F\u002Fpic4.zhimg.com\u002F50\u002F{id}_{size}.jpg&quot;},&quot;isOrgWhiteList&quot;:false,&quot;isBanned&quot;:false},&quot;memberId&quot;:10760740,&quot;excerptTitle&quot;:&quot;&quot;,&quot;voteType&quot;:&quot;ARTICLE_VOTE_CLEAR&quot;},&quot;id&quot;:922542}],&quot;title&quot;:&quot;【游戏框架系列】简单的图形学（三）——光源&quot;,&quot;author&quot;:&quot;bajdcc&quot;,&quot;content&quot;:&quot;\u003Cp\u003E参考自：\u003Ca href=\&quot;http:\u002F\u002Flink.zhihu.com\u002F?target=http%3A\u002F\u002Fwww.cnblogs.com\u002Fmiloyip\u002Farchive\u002F2010\u002F04\u002F02\u002F1702768.html\&quot; class=\&quot; wrap external\&quot; target=\&quot;_blank\&quot; rel=\&quot;nofollow noreferrer\&quot;\u003E用JavaScript玩转计算机图形学(二)基本光源 - Milo Yip - 博客园\u003Ci class=\&quot;icon-external\&quot;\u003E\u003C\u002Fi\u003E\u003C\u002Fa\u003E，主要讲述三种最基本的光源——平行光、点光源、聚光灯，其实就是三种数学模型。\u003C\u002Fp\u003E\u003Cp\u003E\u003Cbr\u003E\u003C\u002Fp\u003E\u003Ch2\u003E代码的调整\u003C\u002Fh2\u003E\u003Cp\u003E先前的代码中，颜色是由几何物体自身计算得出，因此使用很有限。在Phong材质中，显示的效果已经很不错了，然而Phong材质是要假定有一个光源的。我们的代码需要从以面向物体渲染为面向光源渲染。\u003C\u002Fp\u003E\u003Cp\u003E新的逻辑：\u003Ca href=\&quot;http:\u002F\u002Flink.zhihu.com\u002F?target=https%3A\u002F\u002Fgithub.com\u002Fbajdcc\u002FGameFramework\u002Fblob\u002Fmaster\u002FCCGameFramework\u002Fbase\u002Fpe2d\u002FRender2DLight.cpp\&quot; class=\&quot; external\&quot; target=\&quot;_blank\&quot; rel=\&quot;nofollow noreferrer\&quot;\u003E\u003Cspan class=\&quot;invisible\&quot;\u003Ehttps:\u002F\u002F\u003C\u002Fspan\u003E\u003Cspan class=\&quot;visible\&quot;\u003Egithub.com\u002Fbajdcc\u002FGameF\u003C\u002Fspan\u003E\u003Cspan class=\&quot;invisible\&quot;\u003Eramework\u002Fblob\u002Fmaster\u002FCCGameFramework\u002Fbase\u002Fpe2d\u002FRender2DLight.cpp\u003C\u002Fspan\u003E\u003Cspan class=\&quot;ellipsis\&quot;\u003E\u003C\u002Fspan\u003E\u003Ci class=\&quot;icon-external\&quot;\u003E\u003C\u002Fi\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cp\u003E主逻辑 代码：\u003C\u002Fp\u003E\u003Cdiv class=\&quot;highlight\&quot;\u003E\u003Cpre\u003E\u003Ccode class=\&quot;language-cpp\&quot;\u003E\u003Cspan\u003E\u003C\u002Fspan\u003E\u003Cspan class=\&quot;kt\&quot;\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003EPhysicsEngine\u003C\u002Fspan\u003E\u003Cspan class=\&quot;o\&quot;\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003ERenderLightIntern\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003EWorld\u003C\u002Fspan\u003E\u003Cspan class=\&quot;o\&quot;\u003E&amp;amp;\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eworld\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\&quot;k\&quot;\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003EPerspectiveCamera\u003C\u002Fspan\u003E\u003Cspan class=\&quot;o\&quot;\u003E&amp;amp;\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Ecamera\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003EBYTE\u003C\u002Fspan\u003E\u003Cspan class=\&quot;o\&quot;\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Ebuffer\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Ecint\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Ewidth\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Ecint\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eheight\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\&quot;p\&quot;\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;k\&quot;\u003Efor\u003C\u002Fspan\u003E \u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;k\&quot;\u003Eauto\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Ey\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;mi\&quot;\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Ey\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E&amp;lt;\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eheight\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Ey\u003C\u002Fspan\u003E\u003Cspan class=\&quot;o\&quot;\u003E++\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E)\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;p\&quot;\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\&quot;k\&quot;\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\&quot;k\&quot;\u003Eauto\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Esy\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;mf\&quot;\u003E1.0f\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;mf\&quot;\u003E1.0f\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Ey\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E\u002F\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eheight\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E);\u003C\u002Fspan\u003E\n\n        \u003Cspan class=\&quot;k\&quot;\u003Efor\u003C\u002Fspan\u003E \u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;k\&quot;\u003Eauto\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Ex\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;mi\&quot;\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Ex\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E&amp;lt;\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Ewidth\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Ex\u003C\u002Fspan\u003E\u003Cspan class=\&quot;o\&quot;\u003E++\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E)\u003C\u002Fspan\u003E\n        \u003Cspan class=\&quot;p\&quot;\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\&quot;k\&quot;\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\&quot;k\&quot;\u003Eauto\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Esx\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;mf\&quot;\u003E1.0f\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Ex\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E\u002F\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Ewidth\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E\n\n            \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F sx和sy将屏幕投影到[0,1]区间\u003C\u002Fspan\u003E\n\n            \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 产生光线\u003C\u002Fspan\u003E\n            \u003Cspan class=\&quot;k\&quot;\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\&quot;k\&quot;\u003Eauto\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eray\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Ecamera\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003EGenerateRay\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Esx\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Esy\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E);\u003C\u002Fspan\u003E\n\n            \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 测试光线与球是否相交\u003C\u002Fspan\u003E\n            \u003Cspan class=\&quot;k\&quot;\u003Eauto\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eresult\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eworld\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003EIntersect\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Eray\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E);\u003C\u002Fspan\u003E\n            \u003Cspan class=\&quot;k\&quot;\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Eresult\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Ebody\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E)\u003C\u002Fspan\u003E\n            \u003Cspan class=\&quot;p\&quot;\u003E{\u003C\u002Fspan\u003E\n                \u003Cspan class=\&quot;n\&quot;\u003Ecolor\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Ecolor\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E\n                \u003Cspan class=\&quot;k\&quot;\u003Efor\u003C\u002Fspan\u003E \u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;k\&quot;\u003Eauto\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E&amp;amp;\u003C\u002Fspan\u003E \u003Cspan class=\&quot;nl\&quot;\u003Ek\u003C\u002Fspan\u003E \u003Cspan class=\&quot;p\&quot;\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eworld\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Elights\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\&quot;p\&quot;\u003E{\u003C\u002Fspan\u003E \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 这里不一样了\u003C\u002Fspan\u003E\n                    \u003Cspan class=\&quot;k\&quot;\u003Eauto\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003ElightSample\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Ek\u003C\u002Fspan\u003E\u003Cspan class=\&quot;o\&quot;\u003E-&amp;gt;\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003ESample\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Eworld\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eresult\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Eposition\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E);\u003C\u002Fspan\u003E\n\n                    \u003Cspan class=\&quot;k\&quot;\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;o\&quot;\u003E!\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003ElightSample\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Eempty\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E())\u003C\u002Fspan\u003E \u003Cspan class=\&quot;p\&quot;\u003E{\u003C\u002Fspan\u003E\n                        \u003Cspan class=\&quot;k\&quot;\u003Eauto\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003ENdotL\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003EDotProduct\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Eresult\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Enormal\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003ElightSample\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003EL\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E);\u003C\u002Fspan\u003E \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 计算角度\u003C\u002Fspan\u003E\n\n                        \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 夹角为锐角，光源在平面前面\u003C\u002Fspan\u003E\n                        \u003Cspan class=\&quot;k\&quot;\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003ENdotL\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E&amp;gt;=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;mi\&quot;\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E)\u003C\u002Fspan\u003E\n                            \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 累计所有光线\u003C\u002Fspan\u003E\n                            \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F NdotL 就是光源方向在法向量上的投影\u003C\u002Fspan\u003E\n                            \u003Cspan class=\&quot;n\&quot;\u003Ecolor\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Ecolor\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003ElightSample\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003EEL\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003ENdotL\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E);\u003C\u002Fspan\u003E\n                    \u003Cspan class=\&quot;p\&quot;\u003E}\u003C\u002Fspan\u003E\n                \u003Cspan class=\&quot;p\&quot;\u003E}\u003C\u002Fspan\u003E\n                \u003Cspan class=\&quot;n\&quot;\u003Ebuffer\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\&quot;mi\&quot;\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E]\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003EBYTE\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Ecolor\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Eb\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\&quot;mi\&quot;\u003E255\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E);\u003C\u002Fspan\u003E\n                \u003Cspan class=\&quot;n\&quot;\u003Ebuffer\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\&quot;mi\&quot;\u003E1\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E]\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003EBYTE\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Ecolor\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Eg\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\&quot;mi\&quot;\u003E255\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E);\u003C\u002Fspan\u003E\n                \u003Cspan class=\&quot;n\&quot;\u003Ebuffer\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\&quot;mi\&quot;\u003E2\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E]\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003EBYTE\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Ecolor\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Er\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\&quot;mi\&quot;\u003E255\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E);\u003C\u002Fspan\u003E\n                \u003Cspan class=\&quot;n\&quot;\u003Ebuffer\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\&quot;mi\&quot;\u003E3\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E]\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;mi\&quot;\u003E255\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E\n            \u003Cspan class=\&quot;p\&quot;\u003E}\u003C\u002Fspan\u003E\n            \u003Cspan class=\&quot;k\&quot;\u003Eelse\u003C\u002Fspan\u003E\n            \u003Cspan class=\&quot;p\&quot;\u003E{\u003C\u002Fspan\u003E\n                \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 没有接触，就是背景色\u003C\u002Fspan\u003E\n                \u003Cspan class=\&quot;n\&quot;\u003Ebuffer\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\&quot;mi\&quot;\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E]\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;mi\&quot;\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E\n                \u003Cspan class=\&quot;n\&quot;\u003Ebuffer\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\&quot;mi\&quot;\u003E1\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E]\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;mi\&quot;\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E\n                \u003Cspan class=\&quot;n\&quot;\u003Ebuffer\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\&quot;mi\&quot;\u003E2\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E]\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;mi\&quot;\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E\n                \u003Cspan class=\&quot;n\&quot;\u003Ebuffer\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\&quot;mi\&quot;\u003E3\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E]\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;mi\&quot;\u003E255\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E\n            \u003Cspan class=\&quot;p\&quot;\u003E}\u003C\u002Fspan\u003E\n\n            \u003Cspan class=\&quot;n\&quot;\u003Ebuffer\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E+=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;mi\&quot;\u003E4\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E\n        \u003Cspan class=\&quot;p\&quot;\u003E}\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;p\&quot;\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\&quot;p\&quot;\u003E}\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp\u003E\u003Cbr\u003E\u003C\u002Fp\u003E\u003Cp\u003E简单来说，就是求出交点时，做：\u003C\u002Fp\u003E\u003Col\u003E\u003Cli\u003E计算各大光源基于该点的光线颜色和光线方向\u003C\u002Fli\u003E\u003Cli\u003E计算光线在交点法向量上的投影，作为颜色混合比的依据\u003C\u002Fli\u003E\u003Cli\u003E将所有颜色累计起来\u003C\u002Fli\u003E\u003C\u002Fol\u003E\u003Cp\u003E\u003Cbr\u003E\u003C\u002Fp\u003E\u003Cp\u003E下面介绍三种光源\u003C\u002Fp\u003E\u003Ch2\u003E平行光\u003C\u002Fh2\u003E\u003Cfigure\u003E\u003Cnoscript\u003E\u003Cimg src=\&quot;https:\u002F\u002Fpic2.zhimg.com\u002Fv2-eebcbf64e85256332bb0c0f94d8cbf4d_b.jpg\&quot; data-rawwidth=\&quot;1031\&quot; data-rawheight=\&quot;628\&quot; class=\&quot;origin_image zh-lightbox-thumb\&quot; width=\&quot;1031\&quot; data-original=\&quot;https:\u002F\u002Fpic2.zhimg.com\u002Fv2-eebcbf64e85256332bb0c0f94d8cbf4d_r.jpg\&quot;\u003E\u003C\u002Fnoscript\u003E\u003Cimg src=\&quot;data:image\u002Fsvg+xml;utf8,&amp;lt;svg%20xmlns=&#x27;http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg&#x27;%20width=&#x27;1031&#x27;%20height=&#x27;628&#x27;&amp;gt;&amp;lt;\u002Fsvg&amp;gt;\&quot; data-rawwidth=\&quot;1031\&quot; data-rawheight=\&quot;628\&quot; class=\&quot;origin_image zh-lightbox-thumb lazy\&quot; width=\&quot;1031\&quot; data-original=\&quot;https:\u002F\u002Fpic2.zhimg.com\u002Fv2-eebcbf64e85256332bb0c0f94d8cbf4d_r.jpg\&quot; data-actualsrc=\&quot;https:\u002F\u002Fpic2.zhimg.com\u002Fv2-eebcbf64e85256332bb0c0f94d8cbf4d_b.jpg\&quot;\u003E\u003Cfigcaption\u003E平行光\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003E平行光的属性：\u003C\u002Fp\u003E\u003Cdiv class=\&quot;highlight\&quot;\u003E\u003Cpre\u003E\u003Ccode class=\&quot;language-cpp\&quot;\u003E\u003Cspan\u003E\u003C\u002Fspan\u003E\u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 平行光\u003C\u002Fspan\u003E\n\u003Cspan class=\&quot;k\&quot;\u003Eclass\u003C\u002Fspan\u003E \u003Cspan class=\&quot;nc\&quot;\u003EDirectionalLight\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\&quot;k\&quot;\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003ELight\u003C\u002Fspan\u003E\n\u003Cspan class=\&quot;p\&quot;\u003E{\u003C\u002Fspan\u003E\n\u003Cspan class=\&quot;k\&quot;\u003Epublic\u003C\u002Fspan\u003E\u003Cspan class=\&quot;o\&quot;\u003E:\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;n\&quot;\u003EDirectionalLight\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Ecolor\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eirradiance\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Evector3\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Edirection\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E);\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\&quot;n\&quot;\u003ELightSample\u003C\u002Fspan\u003E \u003Cspan class=\&quot;nf\&quot;\u003ESample\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003EWorld\u003C\u002Fspan\u003E\u003Cspan class=\&quot;o\&quot;\u003E&amp;amp;\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eworld\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Evector3\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eposition\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\&quot;k\&quot;\u003Eoverride\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\&quot;n\&quot;\u003Ecolor\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eirradiance\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E    \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 幅照度\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;n\&quot;\u003Evector3\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Edirection\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E   \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 光照方向\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;n\&quot;\u003Evector3\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003EL\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E           \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 光源方向\u003C\u002Fspan\u003E\n\u003Cspan class=\&quot;p\&quot;\u003E};\u003C\u002Fspan\u003E\n\n\u003Cspan class=\&quot;n\&quot;\u003EDirectionalLight\u003C\u002Fspan\u003E\u003Cspan class=\&quot;o\&quot;\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003EDirectionalLight\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Ecolor\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eirradiance\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Evector3\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Edirection\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E)\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;o\&quot;\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eirradiance\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Eirradiance\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E),\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Edirection\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Edirection\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\&quot;p\&quot;\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;n\&quot;\u003EL\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E-\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003ENormalize\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Edirection\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E);\u003C\u002Fspan\u003E\n\u003Cspan class=\&quot;p\&quot;\u003E}\u003C\u002Fspan\u003E\n\n\u003Cspan class=\&quot;n\&quot;\u003ELightSample\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003EDirectionalLight\u003C\u002Fspan\u003E\u003Cspan class=\&quot;o\&quot;\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003ESample\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003EWorld\u003C\u002Fspan\u003E\u003Cspan class=\&quot;o\&quot;\u003E&amp;amp;\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eworld\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Evector3\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eposition\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\&quot;p\&quot;\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;k\&quot;\u003Estatic\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003ELightSample\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Ezero\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\&quot;k\&quot;\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Eshadow\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\&quot;p\&quot;\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\&quot;k\&quot;\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003ERay\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003EshadowRay\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Eposition\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003EL\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\&quot;k\&quot;\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\&quot;k\&quot;\u003Eauto\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003EshadowResult\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eworld\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003EIntersect\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003EshadowRay\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\&quot;k\&quot;\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003EshadowResult\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Ebody\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E)\u003C\u002Fspan\u003E\n            \u003Cspan class=\&quot;k\&quot;\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Ezero\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;p\&quot;\u003E}\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\&quot;k\&quot;\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003ELightSample\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003EL\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eirradiance\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E);\u003C\u002Fspan\u003E \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 就返回光源颜色\u003C\u002Fspan\u003E\n\u003Cspan class=\&quot;p\&quot;\u003E}\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp\u003E这里注意L是光源方向单位向量。\u003C\u002Fp\u003E\u003Cp\u003E平行光我们只需要知道光源方向和光源颜色就可以了。非常简单，不用算投影，这是主逻辑的工作。\u003C\u002Fp\u003E\u003Cp\u003E这里说一下阴影，平行光有阴影，当从交点向光源方向看时，如果中间有障碍物，就返回黑色。\u003C\u002Fp\u003E\u003Cp\u003E\u003Cbr\u003E\u003C\u002Fp\u003E\u003Ch2\u003E点光源\u003C\u002Fh2\u003E\u003Cfigure\u003E\u003Cnoscript\u003E\u003Cimg src=\&quot;https:\u002F\u002Fpic1.zhimg.com\u002Fv2-359fc82a77ddc70179ca78a0ea62b2e8_b.jpg\&quot; data-rawwidth=\&quot;1031\&quot; data-rawheight=\&quot;628\&quot; class=\&quot;origin_image zh-lightbox-thumb\&quot; width=\&quot;1031\&quot; data-original=\&quot;https:\u002F\u002Fpic1.zhimg.com\u002Fv2-359fc82a77ddc70179ca78a0ea62b2e8_r.jpg\&quot;\u003E\u003C\u002Fnoscript\u003E\u003Cimg src=\&quot;data:image\u002Fsvg+xml;utf8,&amp;lt;svg%20xmlns=&#x27;http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg&#x27;%20width=&#x27;1031&#x27;%20height=&#x27;628&#x27;&amp;gt;&amp;lt;\u002Fsvg&amp;gt;\&quot; data-rawwidth=\&quot;1031\&quot; data-rawheight=\&quot;628\&quot; class=\&quot;origin_image zh-lightbox-thumb lazy\&quot; width=\&quot;1031\&quot; data-original=\&quot;https:\u002F\u002Fpic1.zhimg.com\u002Fv2-359fc82a77ddc70179ca78a0ea62b2e8_r.jpg\&quot; data-actualsrc=\&quot;https:\u002F\u002Fpic1.zhimg.com\u002Fv2-359fc82a77ddc70179ca78a0ea62b2e8_b.jpg\&quot;\u003E\u003Cfigcaption\u003E点光源\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cdiv class=\&quot;highlight\&quot;\u003E\u003Cpre\u003E\u003Ccode class=\&quot;language-cpp\&quot;\u003E\u003Cspan\u003E\u003C\u002Fspan\u003E\u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 点光源\u003C\u002Fspan\u003E\n\u003Cspan class=\&quot;k\&quot;\u003Eclass\u003C\u002Fspan\u003E \u003Cspan class=\&quot;nc\&quot;\u003EPointLight\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\&quot;k\&quot;\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003ELight\u003C\u002Fspan\u003E\n\u003Cspan class=\&quot;p\&quot;\u003E{\u003C\u002Fspan\u003E\n\u003Cspan class=\&quot;k\&quot;\u003Epublic\u003C\u002Fspan\u003E\u003Cspan class=\&quot;o\&quot;\u003E:\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;n\&quot;\u003EPointLight\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Ecolor\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eintensity\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Evector3\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eposition\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E);\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\&quot;n\&quot;\u003ELightSample\u003C\u002Fspan\u003E \u003Cspan class=\&quot;nf\&quot;\u003ESample\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003EWorld\u003C\u002Fspan\u003E\u003Cspan class=\&quot;o\&quot;\u003E&amp;amp;\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eworld\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Evector3\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eposition\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\&quot;k\&quot;\u003Eoverride\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\&quot;n\&quot;\u003Ecolor\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eintensity\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E     \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 幅射强度\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;n\&quot;\u003Evector3\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eposition\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E    \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 光源位置\u003C\u002Fspan\u003E\n\u003Cspan class=\&quot;p\&quot;\u003E};\u003C\u002Fspan\u003E\n\n\u003Cspan class=\&quot;k\&quot;\u003Estatic\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003ELightSample\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Ezero\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E\n\n\u003Cspan class=\&quot;n\&quot;\u003ELightSample\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003EPointLight\u003C\u002Fspan\u003E\u003Cspan class=\&quot;o\&quot;\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003ESample\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003EWorld\u003C\u002Fspan\u003E\u003Cspan class=\&quot;o\&quot;\u003E&amp;amp;\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eworld\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Evector3\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Epos\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\&quot;p\&quot;\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 计算L，但保留r和r^2，供之后使用\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;k\&quot;\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\&quot;k\&quot;\u003Eauto\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Edelta\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eposition\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Epos\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 距离向量\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;k\&quot;\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\&quot;k\&quot;\u003Eauto\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Err\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003ESquareMagnitude\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Edelta\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E);\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;k\&quot;\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\&quot;k\&quot;\u003Eauto\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Er\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Esqrtf\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Err\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E);\u003C\u002Fspan\u003E \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 算出光源到pos的距离\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;k\&quot;\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\&quot;k\&quot;\u003Eauto\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003EL\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Edelta\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E\u002F\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Er\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 距离单位向量\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\&quot;k\&quot;\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Eshadow\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\&quot;p\&quot;\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\&quot;k\&quot;\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003ERay\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003EshadowRay\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Epos\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003EL\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\&quot;k\&quot;\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\&quot;k\&quot;\u003Eauto\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003EshadowResult\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eworld\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003EIntersect\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003EshadowRay\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 在r以内的相交点才会遮蔽光源\u003C\u002Fspan\u003E\n        \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F shadowResult.distance &amp;lt;= r 表示：\u003C\u002Fspan\u003E\n        \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F   以pos交点 -&amp;gt; 光源位置 发出一条阴影测试光线\u003C\u002Fspan\u003E\n        \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F   如果阴影测试光线与其他物体有交点，那么相交距离 &amp;lt;= r\u003C\u002Fspan\u003E\n        \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F   说明pos位置无法直接看到光源\u003C\u002Fspan\u003E\n        \u003Cspan class=\&quot;k\&quot;\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003EshadowResult\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Ebody\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E&amp;amp;&amp;amp;\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003EshadowResult\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Edistance\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E&amp;lt;=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Er\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E)\u003C\u002Fspan\u003E\n            \u003Cspan class=\&quot;k\&quot;\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Ezero\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;p\&quot;\u003E}\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 平方反比衰减\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;k\&quot;\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\&quot;k\&quot;\u003Eauto\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eattenuation\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;mi\&quot;\u003E1\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E\u002F\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Err\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 返回衰减后的光源颜色\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;k\&quot;\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\&quot;nf\&quot;\u003ELightSample\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003EL\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eintensity\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eattenuation\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E);\u003C\u002Fspan\u003E\n\u003Cspan class=\&quot;p\&quot;\u003E}\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp\u003E点光源有一个平方反比衰减规律，故而要先算光源到交点pos的距离r，然后求出L，实际上L就是光源位置到交点的方向单位向量。接着要计算颜色，点光源本身颜色intensity，由于有衰减，因此变成了intensity * attenuation。\u003C\u002Fp\u003E\u003Cp\u003E再说下阴影，如何计算点光源的阴影？这比平行光复杂些。从交点处向光源位置发出一条光线，如果当中有障碍物，那么被遮挡，返回黑色（就是遮挡测试）。\u003C\u002Fp\u003E\u003Cp\u003E\u003Cbr\u003E\u003C\u002Fp\u003E\u003Ch2\u003E聚光灯\u003C\u002Fh2\u003E\u003Cfigure\u003E\u003Cnoscript\u003E\u003Cimg src=\&quot;https:\u002F\u002Fpic4.zhimg.com\u002Fv2-96c3565e3ac1da63a35a4568df23530b_b.jpg\&quot; data-rawwidth=\&quot;1031\&quot; data-rawheight=\&quot;628\&quot; class=\&quot;origin_image zh-lightbox-thumb\&quot; width=\&quot;1031\&quot; data-original=\&quot;https:\u002F\u002Fpic4.zhimg.com\u002Fv2-96c3565e3ac1da63a35a4568df23530b_r.jpg\&quot;\u003E\u003C\u002Fnoscript\u003E\u003Cimg src=\&quot;data:image\u002Fsvg+xml;utf8,&amp;lt;svg%20xmlns=&#x27;http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg&#x27;%20width=&#x27;1031&#x27;%20height=&#x27;628&#x27;&amp;gt;&amp;lt;\u002Fsvg&amp;gt;\&quot; data-rawwidth=\&quot;1031\&quot; data-rawheight=\&quot;628\&quot; class=\&quot;origin_image zh-lightbox-thumb lazy\&quot; width=\&quot;1031\&quot; data-original=\&quot;https:\u002F\u002Fpic4.zhimg.com\u002Fv2-96c3565e3ac1da63a35a4568df23530b_r.jpg\&quot; data-actualsrc=\&quot;https:\u002F\u002Fpic4.zhimg.com\u002Fv2-96c3565e3ac1da63a35a4568df23530b_b.jpg\&quot;\u003E\u003Cfigcaption\u003E聚光灯\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cdiv class=\&quot;highlight\&quot;\u003E\u003Cpre\u003E\u003Ccode class=\&quot;language-cpp\&quot;\u003E\u003Cspan\u003E\u003C\u002Fspan\u003E\u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 聚光灯\u003C\u002Fspan\u003E\n\u003Cspan class=\&quot;k\&quot;\u003Eclass\u003C\u002Fspan\u003E \u003Cspan class=\&quot;nc\&quot;\u003ESpotLight\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\&quot;k\&quot;\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003ELight\u003C\u002Fspan\u003E\n\u003Cspan class=\&quot;p\&quot;\u003E{\u003C\u002Fspan\u003E\n\u003Cspan class=\&quot;k\&quot;\u003Epublic\u003C\u002Fspan\u003E\u003Cspan class=\&quot;o\&quot;\u003E:\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;n\&quot;\u003ESpotLight\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Ecolor\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eintensity\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Evector3\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eposition\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Evector3\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Edirection\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\&quot;kt\&quot;\u003Efloat\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Etheta\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\&quot;kt\&quot;\u003Efloat\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Ephi\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\&quot;kt\&quot;\u003Efloat\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Efalloff\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E);\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\&quot;n\&quot;\u003ELightSample\u003C\u002Fspan\u003E \u003Cspan class=\&quot;nf\&quot;\u003ESample\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003EWorld\u003C\u002Fspan\u003E\u003Cspan class=\&quot;o\&quot;\u003E&amp;amp;\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eworld\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Evector3\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eposition\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\&quot;k\&quot;\u003Eoverride\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\&quot;n\&quot;\u003Ecolor\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eintensity\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E     \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 幅射强度\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;n\&quot;\u003Evector3\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eposition\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E    \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 光源位置\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;n\&quot;\u003Evector3\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Edirection\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E   \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 光照方向\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;kt\&quot;\u003Efloat\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Etheta\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E         \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 内圆锥的内角\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;kt\&quot;\u003Efloat\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Ephi\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E           \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 外圆锥的内角\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;kt\&quot;\u003Efloat\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Efalloff\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E       \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 衰减\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\&quot;cm\&quot;\u003E\u002F* 以下为预计算常量 *\u002F\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;n\&quot;\u003Evector3\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003ES\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E           \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 光源方向\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;kt\&quot;\u003Efloat\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003EcosTheta\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E      \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F cos(内圆锥角)\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;kt\&quot;\u003Efloat\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003EcosPhi\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E        \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F cos(外圆锥角)\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;kt\&quot;\u003Efloat\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003EbaseMultiplier\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 1\u002F(cosTheta-cosPhi)\u003C\u002Fspan\u003E\n\u003Cspan class=\&quot;p\&quot;\u003E};\u003C\u002Fspan\u003E\n\n\u003Cspan class=\&quot;n\&quot;\u003ESpotLight\u003C\u002Fspan\u003E\u003Cspan class=\&quot;o\&quot;\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003ESpotLight\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Ecolor\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eintensity\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Evector3\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eposition\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Evector3\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Edirection\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\&quot;kt\&quot;\u003Efloat\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Etheta\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\&quot;kt\&quot;\u003Efloat\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Ephi\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\&quot;kt\&quot;\u003Efloat\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Efalloff\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E)\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;o\&quot;\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eintensity\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Eintensity\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E),\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eposition\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Eposition\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E),\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Edirection\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Edirection\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E),\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Etheta\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Etheta\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E),\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Ephi\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Ephi\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E),\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Efalloff\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Efalloff\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\&quot;p\&quot;\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;n\&quot;\u003ES\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E-\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003ENormalize\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Edirection\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E);\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;n\&quot;\u003EcosTheta\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Ecosf\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Etheta\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\&quot;kt\&quot;\u003Efloat\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003EM_PI\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E\u002F\u003C\u002Fspan\u003E \u003Cspan class=\&quot;mf\&quot;\u003E360.0f\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E);\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;n\&quot;\u003EcosPhi\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Ecosf\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Ephi\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\&quot;kt\&quot;\u003Efloat\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003EM_PI\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E\u002F\u003C\u002Fspan\u003E \u003Cspan class=\&quot;mf\&quot;\u003E360.0f\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E);\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;n\&quot;\u003EbaseMultiplier\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;mf\&quot;\u003E1.0f\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E\u002F\u003C\u002Fspan\u003E \u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003EcosTheta\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003EcosPhi\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E);\u003C\u002Fspan\u003E\n\u003Cspan class=\&quot;p\&quot;\u003E}\u003C\u002Fspan\u003E\n\n\u003Cspan class=\&quot;n\&quot;\u003ELightSample\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003ESpotLight\u003C\u002Fspan\u003E\u003Cspan class=\&quot;o\&quot;\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003ESample\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003EWorld\u003C\u002Fspan\u003E\u003Cspan class=\&quot;o\&quot;\u003E&amp;amp;\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eworld\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Evector3\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Epos\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\&quot;p\&quot;\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 计算L，但保留r和r^2，供之后使用\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;k\&quot;\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\&quot;k\&quot;\u003Eauto\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Edelta\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eposition\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Epos\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 距离向量\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;k\&quot;\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\&quot;k\&quot;\u003Eauto\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Err\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003ESquareMagnitude\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Edelta\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E);\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;k\&quot;\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\&quot;k\&quot;\u003Eauto\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Er\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Esqrtf\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Err\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E);\u003C\u002Fspan\u003E \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 算出光源到pos的距离\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;k\&quot;\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\&quot;k\&quot;\u003Eauto\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003EL\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Edelta\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E\u002F\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Er\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 距离单位向量\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\&quot;cm\&quot;\u003E\u002F*\u003C\u002Fspan\u003E\n\u003Cspan class=\&quot;cm\&quot;\u003E     * spot(alpha) =\u003C\u002Fspan\u003E\n\u003Cspan class=\&quot;cm\&quot;\u003E     *\u003C\u002Fspan\u003E\n\u003Cspan class=\&quot;cm\&quot;\u003E     *     1\u003C\u002Fspan\u003E\n\u003Cspan class=\&quot;cm\&quot;\u003E     *         where cos(alpha) &amp;gt;= cos(theta\u002F2)\u003C\u002Fspan\u003E\n\u003Cspan class=\&quot;cm\&quot;\u003E     *\u003C\u002Fspan\u003E\n\u003Cspan class=\&quot;cm\&quot;\u003E     *     pow( (cos(alpha) - cos(phi\u002F2)) \u002F (cos(theta\u002F2) - cos(phi\u002F2)) , p)\u003C\u002Fspan\u003E\n\u003Cspan class=\&quot;cm\&quot;\u003E     *         where cos(phi\u002F2) &amp;lt; cos(alpha) &amp;lt; cos(theta\u002F2)\u003C\u002Fspan\u003E\n\u003Cspan class=\&quot;cm\&quot;\u003E     *\u003C\u002Fspan\u003E\n\u003Cspan class=\&quot;cm\&quot;\u003E     *     0\u003C\u002Fspan\u003E\n\u003Cspan class=\&quot;cm\&quot;\u003E     *         where cos(alpha) &amp;lt;= cos(phi\u002F2)\u003C\u002Fspan\u003E\n\u003Cspan class=\&quot;cm\&quot;\u003E     *\u002F\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 计算spot\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;k\&quot;\u003Eauto\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Espot\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;mf\&quot;\u003E0.0f\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;k\&quot;\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\&quot;k\&quot;\u003Eauto\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003ESdotL\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003EDotProduct\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003ES\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003EL\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E);\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;k\&quot;\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003ESdotL\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E&amp;gt;=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003EcosTheta\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E)\u003C\u002Fspan\u003E\n        \u003Cspan class=\&quot;n\&quot;\u003Espot\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;mf\&quot;\u003E1.0f\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;k\&quot;\u003Eelse\u003C\u002Fspan\u003E \u003Cspan class=\&quot;nf\&quot;\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003ESdotL\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E&amp;lt;=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003EcosPhi\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E)\u003C\u002Fspan\u003E\n        \u003Cspan class=\&quot;n\&quot;\u003Espot\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;mf\&quot;\u003E0.0f\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;k\&quot;\u003Eelse\u003C\u002Fspan\u003E\n        \u003Cspan class=\&quot;n\&quot;\u003Espot\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Epowf\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E((\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003ESdotL\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003EcosPhi\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003EbaseMultiplier\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Efalloff\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E);\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\&quot;k\&quot;\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Eshadow\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\&quot;p\&quot;\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\&quot;k\&quot;\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003ERay\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003EshadowRay\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Epos\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003EL\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\&quot;k\&quot;\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\&quot;k\&quot;\u003Eauto\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003EshadowResult\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eworld\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003EIntersect\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003EshadowRay\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 在r以内的相交点才会遮蔽光源\u003C\u002Fspan\u003E\n        \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F shadowResult.distance &amp;lt;= r 表示：\u003C\u002Fspan\u003E\n        \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F   以pos交点 -&amp;gt; 光源位置 发出一条阴影测试光线\u003C\u002Fspan\u003E\n        \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F   如果阴影测试光线与其他物体有交点，那么相交距离 &amp;lt;= r\u003C\u002Fspan\u003E\n        \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F   说明pos位置无法直接看到光源\u003C\u002Fspan\u003E\n        \u003Cspan class=\&quot;k\&quot;\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003EshadowResult\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Ebody\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E&amp;amp;&amp;amp;\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003EshadowResult\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Edistance\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E&amp;lt;=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Er\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E)\u003C\u002Fspan\u003E\n            \u003Cspan class=\&quot;k\&quot;\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Ezero\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;p\&quot;\u003E}\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 平方反比衰减\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;k\&quot;\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\&quot;k\&quot;\u003Eauto\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eattenuation\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\&quot;mi\&quot;\u003E1\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E\u002F\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Err\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E;\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\&quot;c1\&quot;\u003E\u002F\u002F 返回衰减后的光源颜色\u003C\u002Fspan\u003E\n    \u003Cspan class=\&quot;k\&quot;\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\&quot;nf\&quot;\u003ELightSample\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003EL\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Eintensity\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\&quot;p\&quot;\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\&quot;n\&quot;\u003Eattenuation\u003C\u002Fspan\u003E \u003Cspan class=\&quot;o\&quot;\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\&quot;n\&quot;\u003Espot\u003C\u002Fspan\u003E\u003Cspan class=\&quot;p\&quot;\u003E));\u003C\u002Fspan\u003E\n\u003Cspan class=\&quot;p\&quot;\u003E}\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp\u003E聚光灯是非常复杂的数学模型，我们不去探究为什么公式这样的，只要实现就行。\u003C\u002Fp\u003E\u003Cp\u003E纯数学计算不多讲，这里主要有一个spot（聚光灯系数），所以最后的颜色是intensity * (attenuation * spot)。其它跟点光源的实现也差不多。\u003C\u002Fp\u003E\u003Cp\u003E\u003Cbr\u003E\u003C\u002Fp\u003E\u003Ch2\u003E三原色混合\u003C\u002Fh2\u003E\u003Cfigure\u003E\u003Cnoscript\u003E\u003Cimg src=\&quot;https:\u002F\u002Fpic2.zhimg.com\u002Fv2-41d32560b89247764d277c3eb5e4924d_b.jpg\&quot; data-rawwidth=\&quot;1031\&quot; data-rawheight=\&quot;628\&quot; class=\&quot;origin_image zh-lightbox-thumb\&quot; width=\&quot;1031\&quot; data-original=\&quot;https:\u002F\u002Fpic2.zhimg.com\u002Fv2-41d32560b89247764d277c3eb5e4924d_r.jpg\&quot;\u003E\u003C\u002Fnoscript\u003E\u003Cimg src=\&quot;data:image\u002Fsvg+xml;utf8,&amp;lt;svg%20xmlns=&#x27;http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg&#x27;%20width=&#x27;1031&#x27;%20height=&#x27;628&#x27;&amp;gt;&amp;lt;\u002Fsvg&amp;gt;\&quot; data-rawwidth=\&quot;1031\&quot; data-rawheight=\&quot;628\&quot; class=\&quot;origin_image zh-lightbox-thumb lazy\&quot; width=\&quot;1031\&quot; data-original=\&quot;https:\u002F\u002Fpic2.zhimg.com\u002Fv2-41d32560b89247764d277c3eb5e4924d_r.jpg\&quot; data-actualsrc=\&quot;https:\u002F\u002Fpic2.zhimg.com\u002Fv2-41d32560b89247764d277c3eb5e4924d_b.jpg\&quot;\u003E\u003Cfigcaption\u003E光的三原色\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003Cp\u003E原想这东西怎么实现啊，现在想通了，就是在某点处(plane上一点)三个聚光灯打上去，将最终的颜色混合起来(加起来)。\u003C\u002Fp\u003E\u003Cp\u003E简单表述：三个光源的光分别为RGB(255,0,0)、RGB(0,255,0)、RGB(0,0,255)，混合起来，加一下就是RGB(255,255,255)，白色。\u003C\u002Fp\u003E\u003Cp\u003E看到\u003Ca href=\&quot;http:\u002F\u002Flink.zhihu.com\u002F?target=http%3A\u002F\u002Fwww.cnblogs.com\u002Fmiloyip\u002Farchive\u002F2010\u002F04\u002F02\u002F1702768.html\&quot; class=\&quot; wrap external\&quot; target=\&quot;_blank\&quot; rel=\&quot;nofollow noreferrer\&quot;\u003E用JavaScript玩转计算机图形学(二)基本光源 - Milo Yip - 博客园\u003Ci class=\&quot;icon-external\&quot;\u003E\u003C\u002Fi\u003E\u003C\u002Fa\u003E 中的一个问题：\u003C\u002Fp\u003E\u003Cblockquote\u003E如果，幅射强度是负值的话，会怎么样？(虽然未证实反光子(antiphoton)的存在，但读者能想到图形学上的功能么？)\u003C\u002Fblockquote\u003E\u003Cp\u003E感觉就是PS中的正片叠底啊，见\u003Ca href=\&quot;https:\u002F\u002Fwww.zhihu.com\u002Fquestion\u002F20354981\&quot; class=\&quot;internal\&quot;\u003E如何简单的理解正片叠底和滤色？\u003C\u002Fa\u003E。\u003C\u002Fp\u003E\u003Cp\u003E\u003Cbr\u003E\u003C\u002Fp\u003E\u003Cp\u003E接下来会探讨画光的实现。\u003C\u002Fp\u003E&quot;,&quot;updated&quot;:new Date(&quot;2017-11-14T02:34:07.000Z&quot;),&quot;canComment&quot;:false,&quot;commentPermission&quot;:&quot;anyone&quot;,&quot;commentCount&quot;:0,&quot;collapsedCount&quot;:0,&quot;likeCount&quot;:2,&quot;state&quot;:&quot;published&quot;,&quot;isLiked&quot;:false,&quot;slug&quot;:&quot;31015884&quot;,&quot;isTitleImageFullScreen&quot;:false,&quot;rating&quot;:&quot;none&quot;,&quot;titleImage&quot;:&quot;https:\u002F\u002Fpic4.zhimg.com\u002Fv2-96c3565e3ac1da63a35a4568df23530b_r.png&quot;,&quot;links&quot;:{&quot;comments&quot;:&quot;\u002Fapi\u002Fposts\u002F31015884\u002Fcomments&quot;},&quot;reviewers&quot;:[],&quot;topics&quot;:[{&quot;url&quot;:&quot;https:\u002F\u002Fwww.zhihu.com\u002Ftopic\u002F19613730&quot;,&quot;id&quot;:&quot;19613730&quot;,&quot;name&quot;:&quot;计算机图形学&quot;},{&quot;url&quot;:&quot;https:\u002F\u002Fwww.zhihu.com\u002Ftopic\u002F19601705&quot;,&quot;id&quot;:&quot;19601705&quot;,&quot;name&quot;:&quot;C \u002F C++&quot;},{&quot;url&quot;:&quot;https:\u002F\u002Fwww.zhihu.com\u002Ftopic\u002F20065767&quot;,&quot;id&quot;:&quot;20065767&quot;,&quot;name&quot;:&quot;光线跟踪&quot;}],&quot;adminClosedComment&quot;:false,&quot;titleImageSize&quot;:{&quot;width&quot;:1031,&quot;height&quot;:628},&quot;href&quot;:&quot;\u002Fapi\u002Fposts\u002F31015884&quot;,&quot;excerptTitle&quot;:&quot;&quot;,&quot;tipjarState&quot;:&quot;inactivated&quot;,&quot;annotationAction&quot;:[],&quot;sourceUrl&quot;:&quot;&quot;,&quot;pageCommentsCount&quot;:0,&quot;hasPublishingDraft&quot;:false,&quot;snapshotUrl&quot;:&quot;&quot;,&quot;publishedTime&quot;:&quot;2017-11-14T10:34:07+08:00&quot;,&quot;url&quot;:&quot;\u002Fp\u002F31015884&quot;,&quot;lastestLikers&quot;:[{&quot;bio&quot;:&quot;若爱，请深爱。&quot;,&quot;isFollowing&quot;:false,&quot;hash&quot;:&quot;e54c48d121a9e6fbc392f9ca03691ad0&quot;,&quot;uid&quot;:809742170792796200,&quot;isOrg&quot;:false,&quot;slug&quot;:&quot;zhao-xiao-guo-35-7&quot;,&quot;isFollowed&quot;:false,&quot;description&quot;:&quot;唯有骑行和代码不可辜负，期待再次长途奔袭。&quot;,&quot;name&quot;:&quot;赵小果&quot;,&quot;profileUrl&quot;:&quot;https:\u002F\u002Fwww.zhihu.com\u002Fpeople\u002Fzhao-xiao-guo-35-7&quot;,&quot;avatar&quot;:{&quot;id&quot;:&quot;v2-1360d9202a72976effe3615921f95c54&quot;,&quot;template&quot;:&quot;https:\u002F\u002Fpic1.zhimg.com\u002F50\u002F{id}_{size}.jpg&quot;},&quot;isOrgWhiteList&quot;:false,&quot;isBanned&quot;:false},{&quot;bio&quot;:&quot;&quot;,&quot;isFollowing&quot;:false,&quot;hash&quot;:&quot;387cbba2f9a1b8ed7ec9e2328bee6471&quot;,&quot;uid&quot;:52532911013888,&quot;isOrg&quot;:false,&quot;slug&quot;:&quot;feng-yu-sheng-1&quot;,&quot;isFollowed&quot;:false,&quot;description&quot;:&quot;&quot;,&quot;name&quot;:&quot;小菜鸟&quot;,&quot;profileUrl&quot;:&quot;https:\u002F\u002Fwww.zhihu.com\u002Fpeople\u002Ffeng-yu-sheng-1&quot;,&quot;avatar&quot;:{&quot;id&quot;:&quot;da8e974dc&quot;,&quot;template&quot;:&quot;https:\u002F\u002Fpic1.zhimg.com\u002F{id}_{size}.jpg&quot;},&quot;isOrgWhiteList&quot;:false,&quot;isBanned&quot;:false}],&quot;summary&quot;:&quot;\u003Cimg src=\&quot;https:\u002F\u002Fpic2.zhimg.com\u002F50\u002Fv2-eebcbf64e85256332bb0c0f94d8cbf4d_200x112.jpg\&quot; data-caption=\&quot;平行光\&quot; data-rawwidth=\&quot;1031\&quot; data-rawheight=\&quot;628\&quot; class=\&quot;origin_image inline-img zh-lightbox-thumb\&quot; data-original=\&quot;https:\u002F\u002Fpic2.zhimg.com\u002F50\u002Fv2-eebcbf64e85256332bb0c0f94d8cbf4d_r.jpg\&quot;\u003E参考自：\u003Ca href=\&quot;http:\u002F\u002Fwww.cnblogs.com\u002Fmiloyip\u002Farchive\u002F2010\u002F04\u002F02\u002F1702768.html\&quot;\u003E用JavaScript玩转计算机图形学(二)基本光源 - Milo Yip - 博客园\u003C\u002Fa\u003E，主要讲述三种最基本的光源——平行光、点光源、聚光灯，其实就是三种数学模型。 代码的调整先前的代码中，颜色是由几何物体自身计算得出，因此使用很有限。在Phong材质中，显示的效…&quot;,&quot;reviewingCommentsCount&quot;:0,&quot;meta&quot;:{&quot;previous&quot;:null,&quot;next&quot;:null},&quot;annotationDetail&quot;:null,&quot;commentsCount&quot;:0,&quot;likesCount&quot;:2,&quot;FULLINFO&quot;:true}},&quot;User&quot;:{&quot;bajdcc&quot;:{&quot;isFollowed&quot;:false,&quot;name&quot;:&quot;陈安&quot;,&quot;headline&quot;:&quot;专业研究野生技术 https:\u002F\u002Fgithub.com\u002Fbajdcc&quot;,&quot;avatarUrl&quot;:&quot;https:\u002F\u002Fpic4.zhimg.com\u002F50\u002Fv2-cd6d61ad9ef94c41b9e77f8e0f727893_s.jpg&quot;,&quot;isFollowing&quot;:false,&quot;type&quot;:&quot;people&quot;,&quot;slug&quot;:&quot;bajdcc&quot;,&quot;bio&quot;:&quot;专业研究野生技术&quot;,&quot;hash&quot;:&quot;7a228f3d98a5d011f952110c10dc4976&quot;,&quot;uid&quot;:71809588264960,&quot;isOrg&quot;:false,&quot;description&quot;:&quot;专业研究野生技术 https:\u002F\u002Fgithub.com\u002Fbajdcc&quot;,&quot;badge&quot;:{&quot;identity&quot;:null,&quot;bestAnswerer&quot;:null},&quot;profileUrl&quot;:&quot;https:\u002F\u002Fwww.zhihu.com\u002Fpeople\u002Fbajdcc&quot;,&quot;avatar&quot;:{&quot;id&quot;:&quot;v2-cd6d61ad9ef94c41b9e77f8e0f727893&quot;,&quot;template&quot;:&quot;https:\u002F\u002Fpic4.zhimg.com\u002F50\u002F{id}_{size}.jpg&quot;},&quot;isOrgWhiteList&quot;:false,&quot;isBanned&quot;:false}},&quot;Comment&quot;:{},&quot;favlists&quot;:{}},&quot;me&quot;:{},&quot;global&quot;:{&quot;experimentFeatures&quot;:{&quot;ge3&quot;:&quot;ge3_9&quot;,&quot;ge2&quot;:&quot;ge2_1&quot;,&quot;nwebStickySidebar&quot;:&quot;sticky&quot;,&quot;androidPassThroughPush&quot;:&quot;all&quot;,&quot;newMore&quot;:&quot;new&quot;,&quot;nwebFeedAd&quot;:&quot;experiment&quot;,&quot;newSign&quot;:&quot;newVersion&quot;,&quot;liveReviewBuyBar&quot;:&quot;live_review_buy_bar_2&quot;,&quot;qawebRelatedReadingsContentControl&quot;:&quot;open&quot;,&quot;liveStore&quot;:&quot;ls_a2_b2_c1_f2&quot;,&quot;qawebThumbnailAbtest&quot;:&quot;new&quot;,&quot;searchHybridTabs&quot;:&quot;without-tabs&quot;,&quot;enableVoteDownReasonMenu&quot;:&quot;disable&quot;,&quot;iOSEnableFeedModuleWWANAritclePreRender&quot;:&quot;iOS_FeedModule_WWAN_PreRender_Enable&quot;,&quot;isOffice&quot;:&quot;false&quot;,&quot;enableTtsPlay&quot;:&quot;false&quot;,&quot;liveDetailWechatBanner&quot;:&quot;Live_detail_wechat_banner_1&quot;,&quot;wechatShareModal&quot;:&quot;wechat_share_modal_show&quot;,&quot;newLiveFeedMediacard&quot;:&quot;old&quot;,&quot;homeUi2&quot;:&quot;default&quot;,&quot;showVideoUploadAttention&quot;:&quot;true&quot;,&quot;recommendationAbtest&quot;:&quot;new&quot;,&quot;marketTab&quot;:&quot;market_tab_old&quot;,&quot;qrcodeLogin&quot;:&quot;qrcode&quot;,&quot;isShowUnicomFreeEntry&quot;:&quot;unicom_free_entry_off&quot;,&quot;newMobileColumnAppheader&quot;:&quot;new_header&quot;,&quot;androidDbCommentWithRepinRecord&quot;:&quot;open&quot;,&quot;androidDbRecommendAction&quot;:&quot;open&quot;,&quot;zcmLighting&quot;:&quot;zcm&quot;,&quot;favAct&quot;:&quot;default&quot;,&quot;appStoreRateDialog&quot;:&quot;close&quot;,&quot;mobileQaPageProxyHeifetz&quot;:&quot;m_qa_page_nweb&quot;,&quot;newAppViewRelatedAd&quot;:&quot;yes&quot;,&quot;default&quot;:&quot;None&quot;,&quot;isNewNotiPanel&quot;:&quot;yes&quot;,&quot;androidDbRepinSelection&quot;:&quot;open&quot;,&quot;nwebRelatedAdvert&quot;:&quot;default&quot;,&quot;qaStickySidebar&quot;:&quot;sticky_sidebar&quot;,&quot;androidProfilePanel&quot;:&quot;panel_b&quot;,&quot;nwebWriteAnswer&quot;:&quot;experiment&quot;}},&quot;columns&quot;:{&quot;next&quot;:{}},&quot;columnPosts&quot;:{},&quot;columnSettings&quot;:{&quot;colomnAuthor&quot;:[],&quot;uploadAvatarDetails&quot;:&quot;&quot;,&quot;contributeRequests&quot;:[],&quot;contributeRequestsTotalCount&quot;:0,&quot;inviteAuthor&quot;:&quot;&quot;},&quot;postComments&quot;:{},&quot;postReviewComments&quot;:{&quot;comments&quot;:[],&quot;newComments&quot;:[],&quot;hasMore&quot;:true},&quot;favlistsByUser&quot;:{},&quot;favlistRelations&quot;:{},&quot;promotions&quot;:{},&quot;switches&quot;:{&quot;couldSetPoster&quot;:false},&quot;draft&quot;:{&quot;titleImage&quot;:&quot;&quot;,&quot;titleImageSize&quot;:{},&quot;isTitleImageFullScreen&quot;:false,&quot;canTitleImageFullScreen&quot;:false,&quot;title&quot;:&quot;&quot;,&quot;titleImageUploading&quot;:false,&quot;error&quot;:&quot;&quot;,&quot;content&quot;:&quot;&quot;,&quot;draftLoading&quot;:false,&quot;globalLoading&quot;:false,&quot;pendingVideo&quot;:{&quot;resource&quot;:null,&quot;error&quot;:null}},&quot;drafts&quot;:{&quot;draftsList&quot;:[],&quot;next&quot;:{}},&quot;config&quot;:{&quot;userNotBindPhoneTipString&quot;:{}},&quot;recommendPosts&quot;:{&quot;articleRecommendations&quot;:[],&quot;columnRecommendations&quot;:[]},&quot;env&quot;:{&quot;edition&quot;:{&quot;baidu&quot;:false,&quot;yidianzixun&quot;:false,&quot;qqnews&quot;:false},&quot;isAppView&quot;:false,&quot;appViewConfig&quot;:{&quot;content_padding_top&quot;:128,&quot;content_padding_bottom&quot;:56,&quot;content_padding_left&quot;:16,&quot;content_padding_right&quot;:16,&quot;title_font_size&quot;:22,&quot;body_font_size&quot;:16,&quot;is_dark_theme&quot;:false,&quot;can_auto_load_image&quot;:true,&quot;app_info&quot;:&quot;OS=iOS&quot;},&quot;isApp&quot;:false,&quot;userAgent&quot;:{&quot;ua&quot;:&quot;Wget\u002F1.19.1 (cygwin)&quot;,&quot;browser&quot;:{},&quot;engine&quot;:{},&quot;os&quot;:{},&quot;device&quot;:{},&quot;cpu&quot;:{}}},&quot;message&quot;:{&quot;newCount&quot;:0},&quot;pushNotification&quot;:{&quot;newCount&quot;:0}}</textarea><script src="//static.zhihu.com/hemingway/common.95b19b48d0d6b20aae46.js"></script><script src="//static.zhihu.com/hemingway/app.40eeaeeef4c006d528d0.js"></script><script src="//static.zhihu.com/hemingway/raven.bdd8772ab8ba1205b8ea.js" async="" defer=""></script></body></html>